<?php
/*
 * UpSoonXML v 0.9
 * https://github.com/rodrigomuniz/upSoonXML
 *
 * Copyright 2010, Rodrigo Muniz - @rdmuniz / Wenetus Interactive http://wenetus.com
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 */

// ======================================================================
// ! Read "01.quick-instructions.txt" for a quick guide   
// ! Do NOT edit this file so you can upgrade to a new version more easily
// ======================================================================

require_once('config.php');
require_once('functions.php');

// ============================= 
// Starting internal status
$e = false;
$sent = false;

//check if the xml file is ready
if(!file_exists($dbName)) {
	$e .= "<li>".$lang['xmlFileWarning']."</li>";
} else { //xml found

// ====================================== 
// AJAX
if(isset($_POST['ax'])) {//if submit via ajax ignore other php code
		$token = $_POST['token'];
	if(is_token_valid($token, $yourKey)) {
		$email = trim($_POST['email']);
		$name = trim($_POST['name']);
		$xml = new SimpleXMLElement($dbName, 0, true);

		//email blank?
		if($email == "") {
			$e.= "<li>".$lang['emptyEmail']."</li>";
		} else { //email filled
			//valid email?
			if( !check_email_address($email) ){
				$e .= "<li>".$lang['invalidEmail']." <strong>$email</strong> ".$lang['invalidEmail2']."</li>";
			}
			
		//already subscribed?
		foreach($xml->user as $u) {
			if($email == $u->email) {
				$e.= "<li>".$lang['existingEmail']." <strong>$email</strong> ".$lang['existingEmail2']."</li>";
			}
		}
}

		//name blank?
		if ($nameReq==true) {//name required option
			if($name == "") {
				$e.= "<li>".$lang['emptyName']."</li>";
			}
		}
		
		//if it's all ok, add email and name to the file
		if($e == false){
			$xml = new SimpleXMLElement($dbName, 0, true);
			$user = $xml[0]->addChild('user');
			$user->addChild('email', $email);
			$user->addChild('realname', $name);
			$user->addChild('time', time());
			$xml->asXML($dbName);

			$sent = true;

			$e.= $sent;
		}
	echo $e;
	}//TOKEN
} else {

// ====================================== 
// NO AJAX
		$secret = auth_token($yourKey);
	if(isset($_POST['send'])) {
		$token = $_POST['token'];
	if(is_token_valid($token, $yourKey)) {
		$email = trim($_POST['email']);
		$name = trim($_POST['name']);
		$xml = new SimpleXMLElement($dbName, 0, true);
		
		//email blank?
		if($email == "") {
					$e.= "<li>".$lang['emptyEmail']."</li>";
		} else { //email filled
			//valid email?
			if( !check_email_address($email) ){
					$e .= "<li>".$lang['invalidEmail']." <strong>$email</strong> ".$lang['invalidEmail2']."</li>";
			}

			//already subscribed?
			foreach($xml->user as $u) {
				if($email == $u->email) {
					$e.= "<li>".$lang['existingEmail']." <strong>$email</strong> ".$lang['existingEmail2']."</li>";
				}
			}
		}

		//name blank?
		if ($nameReq==true) {//name required option
			if($name == "") {
					$e.= "<li>".$lang['emptyName']."</li>";
			}
		}

		//if it's all ok, add email and name to the file
		if($e == false){
			$xml = new SimpleXMLElement($dbName, 0, true);
			$user = $xml[0]->addChild('user');
			$user->addChild('email', $email);
			$user->addChild('realname', $name);
			$user->addChild('time', time());
			$xml->asXML($dbName);

			$sent = true;
		}
	} //TOKEN
	}//if subimit no ajax form
  }//if subimit via ajax
}//if XML file exits

if(!isset($_POST['ax'])) { //don't write the page on ajax return
?>
<!DOCTYPE html>
<? if ($myLang == "en") { ?>
<html lang="en">
<? } ?>
<? if ($myLang == "pt_BR") { ?>
<html lang="pt_BR">
<? } ?>
  <head>
    <meta charset="utf-8">
	<title><?=$lang['newSite']?> <? if($when){?><?=$when?><? } else { ?><?=$lang['soon']?><? }?> - <?=$siteName?></title>
<meta name="author" content="Wenetus Interactive - www.wenetus.com">
<? if(!$index){ ?>
<meta name="robots" content="noindex, nofollow">
<? } ?>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta http-equiv="imagetoolbar" content="no">
<!-- IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<?
// ======================================
// All CSS code in the header to avoid creating another file
// Compressed with http://refresh-sf.com/yui/
?>
<style type="text/css">
html{border-top:10px solid #f0f0f0}body{background-color:#FFF;font-family:Helvetica,Arial,sans-serif;font-size:19px;color:#555;margin:0 auto;padding:5px 0;text-align:center;max-width:100%;_width:960px}img{border:0}form{text-align:left;margin:0 auto;padding:25px 3px;width:450px}fieldset{border:1px solid #ddd;border-radius:10px;padding:20px 0}legend{color:#aaa;text-align:center;margin:0 auto;padding:10px 0 0 0}fieldset ul{list-style:none;padding:0;margin:0}fieldset li{float:left;clear:both;padding:6px 0;position:relative;width:100%}fieldset label{display:block;font-size:.8em;font-weight:bold;text-align:right;padding:6px 4px 0 0;width:100px}fieldset label,input{float:left;vertical-align:middle}#email,#name{font-size:.9em;width:260px}form .sub{clear:both;display:block;float:right;cursor:pointer;font-size:12px;font-weight:bold;margin-right:73px}#alert{border-bottom:4px solid #f0f0f0;background-color:#ffd55c;color:#000;font-size:.9em;margin:0 auto;padding:10px;padding-bottom:0;position:fixed;top:0;left:-180px;margin-left:50%;text-align:left;width:360px;cursor:pointer}ul#alert{list-style:none}ul#alert li{padding-bottom:10px}.priv{font-size:11px;padding:4px 70px 6px 103px;margin:0 auto;width:271px;background:#f6f6f6;float:left;clear:both}h1,h2{font-family:'Helvetica Neue UltraLight','HelveticaNeue-UltraLight','Century Gothic',Helvetica,Arial,sans-serif;font-weight:normal;margin:-5px 0 -10px 0;padding:0}h1{color:#aaa;font-size:65px;text-transform:uppercase}h2{font-size:28px}h2 strong{color:#000}.opc{display:none}.hint{display:block;position:absolute;top:14px;right:84px;font-size:12px;cursor:text;color:#8e8e8e;z-index:100}@media(max-width:768px){body{width:100%}img{max-width:80%}form{width:300px}.priv{padding:4px 50px 6px 53px;width:191px}fieldset{padding-top:5px}fieldset label{width:55px}#email,#name{height:20pt;width:210px}.hint{right:28px}form .sub{width:96%;margin-right:5px;margin-top:10px;height:25pt}h1{font-size:40px}h2{font-size:20px;line-height:100%;padding:0 15px}legend{font-size:16px;width:85%}#alert{left:-145px;width:290px}}
<?
// ======================================
// No compressed CSS
/*
html{border-top: 10px solid #f0f0f0}
body {
	background-color: #FFF;
	font-family: Helvetica, Arial, sans-serif;
	font-size: 19px;
	color:#555;
	margin: 0 auto;
	padding: 5px 0;
	text-align: center;
	max-width: 100%;
	_width: 960px;
}
img{border:0}
form {
	text-align: left;
	margin: 0 auto;
	padding: 25px 3px; 
	width: 450px
}
fieldset {
	border: 1px solid #ddd;
		border-radius: 10px;
	padding: 20px 0;
}
legend{
	color: #aaa;
	text-align: center;
	margin: 0 auto;
	padding: 10px 0 0 0
}
fieldset ul {
	list-style: none;
	padding: 0;
	margin: 0
}
fieldset li {
	float: left;
	clear: both;
	padding:6px 0;
	position: relative;
	width: 100%
}
fieldset label {
	display: block;
	font-size: .8em;
	font-weight: bold;
	text-align: right;
	padding: 6px 4px 0 0;
	width: 100px
}
fieldset label, input {
	float: left;
	vertical-align: middle;
}
#email, #name {
	font-size: .9em;
	width: 260px
}
form .sub {	
	clear: both;
	display: block;
	float: right;
	cursor: pointer;
	font-size: 12px;
	font-weight: bold;
	margin-right: 73px
}
#alert {
	border-bottom: 4px solid #f0f0f0;
	background-color:#ffd55c;
	color: #000;
	font-size: .9em;
	margin: 0 auto;
	padding: 10px;
	padding-bottom: 0;
	position: fixed;
	top:0;
	left: -180px;
	margin-left: 50%;
	text-align: left;
	width: 360px;
	cursor: pointer
}
ul#alert {list-style: none}
ul#alert li {padding-bottom: 10px}
.priv {
	font-size: 11px;
	padding: 4px 70px 6px 103px;
	margin: 0 auto;
	width: 271px;
	background: #f6f6f6;
	float: left;
	clear: both;
}
h1, h2 {
	font-family: 'Helvetica Neue UltraLight', 'HelveticaNeue-UltraLight', 'Century Gothic', Helvetica, Arial, sans-serif;
	font-weight: normal;
	margin: -5px 0 -10px 0;
	padding: 0;
}
h1 {
	color: #aaa;
	font-size: 65px;
	text-transform: uppercase;
}
h2{font-size: 28px}
h2 strong {
	color: #000;
}
.opc {display: none;}
.hint {
	display: block;
	position: absolute;
	top: 14px;
	right: 84px;
	font-size: 12px;
	cursor: text;
	color: #8e8e8e;
	z-index: 100;
}
 */ ?>
/* Landscape phone to portrait tablet */
<? /*
@media (max-width: 768px) {

	body {
		width: 100%;
	}
	img{max-width: 80%}
	form {
		width: 300px
	}
	.priv {
		padding: 4px 50px 6px 53px;
		width: 191px
	}
	fieldset {
		padding-top: 5px
	}
	fieldset label {
		width: 55px
	}
	#email, #name {
		height: 20pt;
		width: 210px
	}
	.hint {
		right: 28px
	}
	form .sub {
		width: 96%;
		margin-right: 5px;
		margin-top: 10px;
		height: 25pt
	}
	h1 {
		font-size: 40px
	}
	h2 {
		font-size: 20px;
		line-height: 100%;
		padding: 0 15px
	}
	legend{
		font-size: 16px;
		width: 85%
	}
	#alert {
		left: -145px;
		width: 290px
	}
}
 */ ?>
</style>

<?php
// ====================================== 
// if IE 
if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE') ){ ?>
<!--[if lt IE 8]>
<style type="text/css">
.priv {
	width: 275px;
}
.hint {
	background: #fff;
	top: 10px
}
fieldset label {padding: 3px 4px 0 0}
form .sub {
	overflow: visible;
	padding:1px 3px
}
legend {
	margin: 0 auto;
	text-align: center;
	width:94%;
}
</style>
<![endif]-->

<!--[if IE 6]>
<style type="text/css">
form .sub {
	clear:none;
	margin-right: 40px
}
#alert {
	left: 50%;
	margin-left: -25px;
	position:absolute;
}
</style>
<![endif]-->

<!--[if IE 7]>
<style type="text/css">
form .sub {margin-right: 79px}
</style>
<![endif]-->
<?
}
//if IE
?>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script>
$(document).ready(function() {
$('#email').focus();
<?
// ====================================== 
// JS AJAX
?>
function remAlert() {
	if($('#alert')){
		$('#alert').fadeOut('fast').remove('#alert');
	}
}
var erBlock = "<ul id='alert' title='<?=$lang['close']?>'></ul>";

function processReturn(data){
	if(data == 1) {
		remAlert();
		$("form fieldset").slideUp();
		$("form").before("<p><?=$lang['success']?></p>");
	} else {
		remAlert() 
		$('body').append(erBlock);
		$("#alert").append(data);
		animAlert();
		$('#alert').click(function(){remAlert();});
	}
}

$('.sub').click(function(){
        $('.sub').ajaxStart(function(){
        	$(this).attr('disabled', 'disabled');
        	remAlert();
       		$('body').append(erBlock);
        	$("#alert").append('<li>Analisando...</li>');
        });
        $('.sub').ajaxStop(function(){
        	$(this).removeAttr('disabled');
       	});
        $.post('index.php',
        {ax:true, token: $('#token').val(), email: $('#email').val(), name: $('#name').val()},
        function(data){
                if (data !=''){
                	processReturn(data);
                }
                else{
		            remAlert();
		       		$('body').append(erBlock);
		        	$("#alert").append('<li><?=$lang['connectError']?></li>');
                }
        });
return false;
});

<?
// ====================================== 
// Animations and breathing SPAM alert
?>
<?php if(!$e){ ?>
$("form, .priv").hide(); <? //starting hidden ?>
function toFade() { <? //reduces the opacity ?>
	$(".priv").animate({opacity: '.5'}, 2000, function() {
		resetFade();
	});
}
function resetFade(){ <? //increase opacity ?>
	$(".priv").animate({opacity: '1'}, 1000, function(){
		toFade();
	});
}
$("form").slideDown(600,function(){
	$(".priv").slideDown(400, function(){
			toFade(); <? //start breathing ?>
	});
});
<? } ?>

<?
// ====================================== 
// Animating yellow alert
?>
function animAlert() {
	$("#alert").animate({left: '+=-16'}, 70)
		.animate({left: '+=8'}, 70)
		.animate({left: '+=-8'}, 70)
		.animate({left: '+=8'}, 70)
		.animate({left: '+=-8'}, 70)
		.animate({left: '+=4'}, 70);
}

<?
// ====================================== 
// Hint text (Opcional) used in Name field
?>
<? if($nameReq==false) { ?>
$(".opc").addClass('hint').click(function(){
	$("#name").focus();
});

if($("#name").val().length == 0){
	$(".opc").addClass('hint');
}
$("#name").ready(function(){
	if($("#name").val().length > 0) {
		hideHint();
	}
});

function hideHint(){$(".hint").fadeOut();}
function showHint(){$(".hint").fadeIn();}

$("#name").focus(function(){
	if($("#name").val().length == 0) {
		$(".hint").css('opacity', 0.4);
	}
});
$("#name").blur(function(){
	if($("#name").val().length == 0) {
		showHint();
	}
});
$("#name").keyup(function(){
	if($("#name").val().length == 0) {
		showHint();
	}
	if($("#name").val().length > 0) {
		hideHint();
	}
});
<? } ?>
});
</script>

</head>

<body>
<?php
// ====================================== 
// Write error messages and alerts when there's no Ajax
	if($e){ ?>
	<ul id="alert" title="<?=$lang['close']?>">
	<?=$e?>
	</ul>
<? } ?>

<?php
// ====================================== 
// Logo
	if($logo){?>
	<img src="<?=$logo?>" alt="<?=$lang['logoAlt']?>">
<? } ?>

<? if($h1){ ?>
<h1><?=$lang['titleSoon']?></h1>
<? } ?>

<? if($h2){ ?>
	<h2><?=$lang['titleH2']?><? if($when){?> <br><?=$lang['titleH2Date']?><? }?></h2>
<? } ?>

<?php
// ====================================== 
// Hide form after success with no Ajax
	if($sent==false) { ?>

<form action="index.php" method="post">
	<fieldset>
	<legend><?=$lang['legend']?></legend>

	<ul>
		<li>
			<label for="email"><?=$lang['email']?></label>
			<input type="email" name="email" id="email" value="<?=$email?>">
			<?php if(!$e){?>
			<p class="priv"><?=$lang['spamAlert']?></p>
			<? } ?>
		</li>
		<li>
			<label for="name"><?=$lang['name']?> <? if($nameReq==false) {?><span class="opc">(<?=$lang['optional']?>)</span><? } ?></label>
			<input type="hidden" name="token" id="token" value="<?=$secret;?>">
			<input type="text" name="name" id="name" value="<?=$name?>">
		</li>
	</ul>
	<input type="submit" name="send" value="<?=$lang['submit']?>" class="sub">
	</fieldset>
</form>

<? } else { // success message ?>
	<p><?=$lang['success']?></p>
<? } ?>

<?php
// ====================================== 
// Google Analytics
	if($gaUA) { ?>
		<script>
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', '<?=$gaUA?>']);
			_gaq.push(['_trackPageview']);
			
			(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();
		</script>
<? } //analytics ?>
</body>
</html>
<? } // Don't write page when Ajax ?>